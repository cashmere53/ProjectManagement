<!--############################################################
# specificat on ;
# name     = Good Measure ;
# note     = ;
# date     = 2015/12/6 ;
# author   = Nishi ;
# History  = ver1.0.0 ;
# end of specification ;
#############################################################-->



<div id="gmap" style="width: 80%; height: 500px; border: 1px solid Gray;">
</div>
<span id="distance" style="font-size:36px;padding-right:5px;"></span> km

<%= form_tag('/housing_databases/showTables', :method => :get) do %>
  <input type="hidden" name="inc_account_id" value="<%= @inc_account_id %>" >
  <input type="submit" value="戻る" formaction='/housing_databases/showTables/<%= @inc_account_id %>' formmethod='get' class="btn btn-warning">
<% end %>

<%= form_tag housing_databases_registerDatabases_path(params[:id]),multipart: true do%>
    <table>

      <tbody>
      <% if @message %><tr><td><center><font color="red"><%= @message %></font></center></td></tr><% end %>
      <tr><td>画像</td> <td><%= file_field_tag 'image' %></td> </tr>
      <tr><td>店舗選択</td> <td><%= collection_select(:selectedstore_id,:store_id,@store.all,:id,:store_name) %> <td><%= submit_tag "店舗情報新規登録" ,:name => 'store_register'%></td></td> </tr>
      <tr><td colspan="2"><font color="red">　<%= if @store.blank?
                                                  "店舗情報がありません。登録してください" end %></font></td><tr>
      <tr><td>住所</td> <td><%= text_field_tag :street_address,@housing.street_address, :placeholder => "住所" %></td> </tr>

      <tr><td>家賃</td>  <td><%= text_field_tag :rent,@housing.rent,:placeholder => '家賃'%></td> </tr>

      <tr><td>管理費</td>  <td><%= text_field_tag :administration_cost,@housing.administration_cost,:placeholder => '管理費'%></td> </tr>

      <tr><td>タイプ</td>  <td><%= text_field_tag :housing_type,@housing.housing_type,:placeholder => 'タイプ'%></td></tr>
      <tr><td>建築年月</td>  <td><%= date_select(:date, :building_date, :use_month_numbers => true,:discard_day => true,:default => Date.new(1950, 1, 1),:start_year =>1950,:end_year => 2050)%></td></tr>
      <tr><td>向き</td>  <td><%= text_field_tag :direction,@housing.direction,:placeholder => '向き'%></td></tr>
      <tr><td>間取り</td>  <td><%= text_field_tag :layout,@housing.layout,:placeholder => '間取り'%></td></tr>
      <tr><td>面積</td>  <td><%= text_field_tag :area,@housing.area,:placeholder => '面積'%></td></tr>
      <tr><td>構造</td>  <td><%= text_field_tag :structure,@housing.structure,:placeholder => '構造'%></td></tr>
      <tr><td>階建て</td>  <td><%= text_field_tag :floor,@housing.floor,:placeholder => '階建て'%></td></tr>
      <tr><td>敷金</td>  <td><%= text_field_tag :deposit,@housing.deposit,:placeholder => '敷金'%></td></tr>
      <tr><td>礼金</td>  <td><%= text_field_tag :recompense,@housing.recompense,:placeholder => '礼金'%></td></tr>
      <tr><td>保証金</td>  <td><%= text_field_tag :security_money,@housing.security_money,:placeholder => '保証金'%></td></tr>
      <tr><td>敷引き</td>  <td><%= text_field_tag :shikibiki,@housing.shikibiki,:placeholder => '敷引き'%></td></tr>
      <tr><td>保険料</td>  <td><%= text_field_tag :insurance,@housing.insurance,:placeholder => '保険料'%></td></tr>
      <tr><td>駐車場使用料</td>  <td><%= text_field_tag :parking,@housing.parking,:placeholder => '駐車場使用料'%></td></tr>
      <tr><td>取引態様</td>  <td><%= text_field_tag :trading_aspect,@housing.trading_aspect,:placeholder => '取引態様'%></td></tr>
      <tr><td>他初期費用</td>  <td><%= text_field_tag :another_cost,@housing.another_cost,:placeholder => '他初期費用'%></td></tr>
      <tr><td>空き部屋情報</td>  <td><%= text_field_tag :vacancy,@housing.vacancy,:placeholder => '空き部屋情報'%></td></tr>
      <tr><td>詳細情報</td>  <td><%= text_area_tag :detail,@housing.detail,:placeholder => '詳細情報' ,:size => "50x10"%></td></tr>

      <tr><td>契約プラン</td>  <td><%= radio_button_tag :plan, 1 %> <%= label_tag :plan_name, "年契約" %>
                                    <%= radio_button_tag :plan, 2 %> <%= label_tag :plan_name, "月契約" %></td></tr>


      </tbody>
    </table>

    <%= submit_tag "保存" ,:name => 'save'%>
<% end %>



<script type="text/javascript">
    var mapObj;
    var originMarker;
    var destinationMarker;
    var directionsService = new google.maps.DirectionsService();
    var directionsRenderer = new google.maps.DirectionsRenderer();

    google.maps.event.addDomListener(window, 'load', function()
    {
        var mapOptions = {
            zoom: 12,
            center: null,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            scaleControl: true
        };
        mapObj = new google.maps.Map(document.getElementById('gmap'), mapOptions);

        // ルートを表示するマップを設定（マーカーは非表示）
        directionsRenderer.suppressMarkers = true;
        directionsRenderer.setMap(mapObj);

        // 開始位置、到着位置の設定(新宿→羽田空港)
        originMarker = CreateMarker(new google.maps.LatLng(35.6895788761947, 139.70042914152145));
        destinationMarker = CreateMarker(new google.maps.LatLng(35.5500005870948, 139.78651732206345));

        // ルートを表示する
        UpdateRoute();
    });

    // マーカーを作成します。
    function CreateMarker(latlng)
    {
        var marker = new google.maps.Marker({
            position: latlng,
            map: mapObj,
            draggable: true
        });
        google.maps.event.addListener(marker, "dragend", UpdateRoute);
        return marker;
    }

    // 現在のマーカー位置でルートを更新します。
    function UpdateRoute()
    {
        var request = {
            origin: originMarker.getPosition(),
            destination: destinationMarker.getPosition(),
            travelMode: google.maps.DirectionsTravelMode.DRIVING
        };
        directionsService.route(request, function(result, status)
        {
            if (status == google.maps.DirectionsStatus.OK)
            {
                directionsRenderer.setDirections(result);
                SetDistance(result);
            }
        });
    }

    // 移動距離を設定します。
    function SetDistance(routeData)
    {
        var distance = GetDistanceKm(routeData.routes[0].legs);
        if (distance > 100)
        {
            distance = distance.toFixed(0);
        }
        else if (distance > 10)
        {
            distance = distance.toFixed(1);
        }
        $("#distance").text(distance);
    }

    // 距離を取得します。
    function GetDistanceKm(legs)
    {
        var journey = 0;
        for (var i in legs)
        {
            journey += legs[i].distance.value;
        }
        return journey / 1000;
    }

</script>
